import numpy as np
from PIL import Image

# 提供されたバイナリデータ
binary_data = """
00000010101010000000000001010000010100000001001000100010001001011001010101010101010100100100000000000000000000000000000000000001100000000000000000001101000000000000000000011010000000000000000001010100000000000000000011111000000000000000000000000000000011000011100011000011000100000000000001100100001101000110001100001101011111011111011111011111000000000000000000000000001000000000000000001000000000000000000000000000010000000000000000011111100000000000001111100000000000000000000000110000110000111000110001000000010000000001000011010000110
00111001101011111011111011111011111000000000000000000000000001000000110000000001000000000001100000000000000010000011000000000011111100000110000001111100000000001100000000000001000000001000000001000001000000110000000100000001100001100000010000000000110001000011000000000000000110011000000000000011000100001100000000011000011000000100000001000000100000000100000100000001100000000100010000000011000000001000100000000010000000100000100000001000000010000000100000000000011000000000110000000011000000000100011101011000000000001000000010000000000000010000011111000000000000100001011101001011011000000100111001001111111011100001110000011011100000000010100000111011001000000101000001111110010000001010000011000000100000110110000000000000000000000000000000000011100000100000000000000111010100010101010101001110000000001010101000000000000000010100000000000000111110000000000000000111111111000000000000111000000011100000000011000000000001100000001101000000000101100000110011000000011001100001000101000001010001000010001001000100100010000000010001010001000000000000100001000010000000000001000000000100000000000000100101000000000001111001111101001111000 
"""

# データクレンジング: 不要な文字を除去
binary_data_cleaned = "".join([char for char in binary_data if char in "01"])

# バイナリデータの長さ
length = len(binary_data_cleaned)
assert length == 1679, "データ長が正しくありません。"

# 圧縮: ランレングスエンコーディング (RLE)
def rle_compress(data):
    compressed = []
    count = 1
    for i in range(1, len(data)):
        if data[i] == data[i - 1]:
            count += 1
        else:
            compressed.append((data[i - 1], count))
            count = 1
    compressed.append((data[-1], count))
    return compressed

# 解凍: RLEデータを復元
def rle_decompress(compressed):
    decompressed = []
    for bit, count in compressed:
        decompressed.extend([bit] * count)
    return "".join(decompressed)

# 圧縮実行
compressed_data = rle_compress(binary_data_cleaned)

# 解凍実行
decompressed_data = rle_decompress(compressed_data)
assert binary_data_cleaned == decompressed_data, "復元に失敗しました。"

# 画像の縦横サイズを決定 (可能な限り正方形に近い形)
width = int(np.sqrt(length))
while length % width != 0:
    width -= 1
height = length // width

# バイナリデータを画像データに変換
binary_array = np.array([int(bit) for bit in decompressed_data]).reshape((height, width))

# 画像生成
image = Image.fromarray(np.uint8(binary_array * 255), 'L')  # 白黒画像
image_path = "/mnt/data/reconstructed_image_prime.png"
image.save(image_path)
image.show()

image_path
